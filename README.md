# WhatsApp Notify - Evolution API and ChatPro integration

Sistema avan√ßado de notifica√ß√µes via WhatsApp atrav√©s do recebimento de webhooks, com integra√ß√£o completa com Evolution API, ChatPro API e API de produtos para mensagens personalizadas.

## üöÄ Configura√ß√£o

### 1. Vari√°veis de Ambiente

Copie o arquivo de exemplo e configure suas credenciais:

```bash
cp .env.example .env
```

Configure o arquivo `.env` com suas credenciais da Evolution API:

```env
# Server Configuration
PORT=3000

# Evolution API Configuration
EVOLUTION_API_URL=http://localhost:8080
EVOLUTION_API_KEY=your-api-key-here
EVOLUTION_INSTANCE_NAME=your-instance-name

# ChatPro Configuration (Alternative WhatsApp Provider)
CHATPRO_INSTANCEID=your-chatpro-instance-id
CHATPRO_TOKEN=your-chatpro-token

# Store API Configuration (Product Information)
CUSTOMER_STORE_ID=your-store-id
CUSTOMER_API_KEY=your-store-api-key
```

### 2. Instala√ß√£o

```bash
npm install
```

### 3. Execu√ß√£o

**Desenvolvimento:**
```bash
npm run dev
```

**Produ√ß√£o:**
```bash
npm start
```

## üöÄ Deploy na Vercel

### 1. Prepara√ß√£o do Projeto

O projeto j√° est√° configurado para deploy na Vercel com:
- `vercel.json` - Configura√ß√£o de deployment
- Scripts de build e start no `package.json`

### 2. Deploy via CLI

```bash
# Instalar Vercel CLI
npm i -g vercel

# Login na Vercel
vercel login

# Deploy
vercel --prod
```

### 3. Deploy via GitHub

1. Fa√ßa push do c√≥digo para um reposit√≥rio GitHub
2. Conecte o reposit√≥rio na [Vercel](https://vercel.com)
3. Configure as vari√°veis de ambiente no dashboard da Vercel
4. Deploy autom√°tico ser√° realizado

### 4. Vari√°veis de Ambiente na Vercel

Configure as seguintes vari√°veis no dashboard da Vercel:

```
EVOLUTION_API_URL=your-evolution-api-url
EVOLUTION_API_KEY=your-api-key
EVOLUTION_INSTANCE_NAME=your-instance-name
CHATPRO_INSTANCEID=your-chatpro-instance-id
CHATPRO_TOKEN=your-chatpro-token
CUSTOMER_STORE_ID=your-store-id
CUSTOMER_API_KEY=your-store-api-key
```

**Nota:** A vari√°vel `PORT` n√£o √© necess√°ria na Vercel, pois ela √© gerenciada automaticamente.

## üì° Endpoints

### Webhook para Atualiza√ß√µes de Pedidos
```
POST /webhook/order-update
```

**Payload:**
```json
{
  "orderId": 1,
  "datePurchase": "2025-05-24 00:11:15",
  "total": 1795.1,
  "statusId": 1,
  "status": {
    "type": "pending",
    "color": "#ffffff",
    "label": "Pendente"
  },
  "channel": "website",
  "customer": {
    "id": 1,
    "name": "Nome do Cliente",
    "email": "email@exemplo.com",
    "phone": [
      {
        "ddd": "99",
        "number": "99999999",
        "type": "principal"
      }
    ]
  },
  "payment": {
    "gateway": "paghiper",
    "brand": "pix",
    "amount": 1795.1,
    "installments": 1,
    "type": "default",
    "currency": "BRL"
  },
  "type": "order-changed",
  "domain": "www.dominio.com.br"
}
```

**Status dispon√≠veis:**
- `RESERVADO` - Produto reservado para o cliente
- `AGUARDANDO PAGAMENTO` - Pedido criado, aguardando pagamento
- `PAGO` - Pagamento confirmado
- `PEDIDO RETIRADO` - Produto retirado pelo cliente
- `EM ASSIST√äNCIA` - Produto em assist√™ncia t√©cnica
- `RESERVA CONFIRMADA` - Reserva do produto confirmada
- `Cancelado` - Pedido cancelado

### ChatPro Status Check
```
GET /chatpro/status
```

### ChatPro QR Code Generation
```
GET /chatpro/qrcode
```

### ChatPro QR Code Display (HTML Page)
```
GET /chatpro/qrcode/display
```

### Teste de Mensagem
```
POST /test-message
```

**Payload:**
```json
{
  "phoneNumber": "5511999999999",
  "message": "Mensagem de teste"
}
```

### Health Check
```
GET /webhook/health
```

### API Root (Lista de Endpoints)
```
GET /
```

**Resposta:**
```json
{
  "message": "WhatsApp Notify API is running!",
  "version": "1.0.0",
  "endpoints": {
    "webhook": "/webhook/order-update",
    "health": "/webhook/health",
    "status": "/chatpro/status",
    "qrcode": "/chatpro/qrcode",
    "qrcodeDisplay": "/chatpro/qrcode/display",
    "test": "/test-message"
  }
}
```

## üîß Como Usar

### 1. Configurar APIs

#### Evolution API (Opcional)
1. Execute sua inst√¢ncia da Evolution API
2. Crie uma inst√¢ncia WhatsApp
3. Configure as vari√°veis de ambiente com suas credenciais

#### ChatPro API (Recomendado)
1. Crie uma conta no [ChatPro](https://chatpro.com.br)
2. Obtenha seu Instance ID e Token
3. Configure as vari√°veis de ambiente

#### Store API (Para buscar produtos)
1. Obtenha as credenciais da API da sua loja
2. Configure `CUSTOMER_STORE_ID` e `CUSTOMER_API_KEY`

### 2. Conectar WhatsApp

#### Via ChatPro (Interface Web)
1. Acesse: `http://localhost:3000/chatpro/qrcode/display`
2. Siga as instru√ß√µes na tela
3. Escaneie o QR Code com seu WhatsApp

#### Via Evolution API
1. Acesse o endpoint da Evolution API para gerar QR Code
2. Escaneie o QR Code com seu WhatsApp
3. Aguarde a conex√£o ser estabelecida

### 3. Enviar Notifica√ß√µes
Use o webhook `/webhook/order-update` para enviar notifica√ß√µes autom√°ticas quando o status de um pedido mudar.

## üìã Exemplo de Uso

### Testando o Sistema
```bash
# Verificar status do ChatPro
curl -X GET http://localhost:3000/chatpro/status

# Gerar QR Code (JSON)
curl -X GET http://localhost:3000/chatpro/qrcode

# Enviar mensagem de teste
curl -X POST http://localhost:3000/test-message \
  -H "Content-Type: application/json" \
  -d '{
    "phoneNumber": "5511999999999",
    "message": "Ol√°! Sistema funcionando!"
  }'

# Simular atualiza√ß√£o de pedido com status espec√≠fico
curl -X POST http://localhost:3000/webhook/order-update \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": "PED-001",
    "status": {
      "label": "RESERVADO"
    },
    "customer": {
      "name": "Jo√£o Silva",
      "phone": [
        {
          "ddd": "11",
          "number": "999999999",
          "type": "principal"
        }
      ]
    }
  }'
```

### Exemplo de Mensagem Gerada

Para um pedido com status `RESERVADO`, o sistema gera uma mensagem como:

```
üìã Ol√° Jo√£o Silva! Sua reserva foi feita com sucesso!

üî¢ Pedido: #PED-001
üì¶ Produto(s): ‚Ä¢ Smartphone XYZ
‚Ä¢ Capa Protetora

‚è∞ O produto ficar√° reservado at√© o pr√≥ximo dia √∫til.
üìû Para cancelar a reserva, entre em contato pelo WhatsApp.

‚ö†Ô∏è ATEN√á√ÉO: Produtos reservados e n√£o retirados nos impedem de atender outros lojistas.
```

## üèóÔ∏è Arquitetura

O projeto est√° organizado em camadas com arquitetura hexagonal:

- **Clients**: Comunica√ß√£o com APIs externas
  - `evolution.client.js` - Cliente para Evolution API
  - `chatpro.client.js` - Cliente para ChatPro API
  - `storeapi.client.js` - Cliente para API de produtos da loja
- **Providers**: Abstra√ß√£o para provedores de mensagens WhatsApp
- **Services**: L√≥gica de neg√≥cio
  - `notification.service.js` - Servi√ßo de notifica√ß√µes
  - `order.service.js` - Processamento de pedidos
  - `product.service.js` - Busca de informa√ß√µes de produtos
- **Controllers**: Manipula√ß√£o de requisi√ß√µes HTTP
- **Routers**: Defini√ß√£o de rotas

### Funcionalidades Avan√ßadas

#### üì¶ Integra√ß√£o com API de Produtos
- Busca autom√°tica de nomes dos produtos por ID do pedido
- Cache inteligente de tokens de autentica√ß√£o
- Formata√ß√£o elegante de listas de produtos nas mensagens

#### üé® Mensagens Personalizadas
O sistema cria mensagens personalizadas baseadas no status do pedido:
- Emojis apropriados para cada status
- Informa√ß√µes relevantes (n√∫mero do pedido, produtos, instru√ß√µes)
- Mensagens espec√≠ficas para assist√™ncia t√©cnica com contato dedicado
- Avisos especiais para reservas

#### üîÑ Sistema de Fallback
- Suporte a m√∫ltiplos provedores (Evolution API e ChatPro)
- Configura√ß√£o flex√≠vel para alternar entre provedores
- Tratamento robusto de erros

## üì± Provedores de WhatsApp

### Evolution API
Este projeto foi desenvolvido para funcionar com a [Evolution API](https://github.com/EvolutionAPI/evolution-api), uma API robusta para integra√ß√£o com WhatsApp.

**Recursos Suportados:**
- ‚úÖ Envio de mensagens de texto
- ‚úÖ Verifica√ß√£o de status da inst√¢ncia
- ‚úÖ Gera√ß√£o de QR Code
- üöß Envio de m√≠dia (implementado, mas n√£o usado no webhook)

### ChatPro API
Alternativa comercial √† Evolution API com interface mais simples.

**Recursos Suportados:**
- ‚úÖ Envio de mensagens de texto
- ‚úÖ Verifica√ß√£o de status da conex√£o
- ‚úÖ Gera√ß√£o de QR Code com interface web
- ‚úÖ Display HTML do QR Code com instru√ß√µes

## üõçÔ∏è API de Produtos (Store API)

O sistema integra com uma API de loja para buscar informa√ß√µes dos produtos:

**Funcionalidades:**
- ‚úÖ Autentica√ß√£o autom√°tica com cache de token
- ‚úÖ Busca de produtos por ID do pedido
- ‚úÖ Renova√ß√£o autom√°tica de tokens expirados
- ‚úÖ Tratamento robusto de erros de autentica√ß√£o

**Exemplo de resposta da API:**
```json
{
  "order": {
    "products": [
      {
        "id": 1,
        "name": "Produto Exemplo",
        "quantity": 2,
        "price": 899.99
      }
    ]
  }
}
```

## üîê Seguran√ßa

- Use HTTPS em produ√ß√£o
- Configure sua API Key corretamente
- Valide sempre os dados recebidos nos webhooks
- Monitore os logs para detectar problemas

## üêõ Troubleshooting

### Problemas Comuns:

1. **Erro de conex√£o com APIs**
   - Verifique se as URLs est√£o corretas
   - Confirme se as API Keys s√£o v√°lidas
   - Certifique-se de que as inst√¢ncias existem

2. **Mensagens n√£o enviadas**
   - Verifique se o WhatsApp est√° conectado (`/chatpro/status`)
   - Confirme o formato do n√∫mero de telefone (+55DDNNNNNNNNN)
   - Veja os logs para detalhes do erro

3. **Webhook n√£o funcionando**
   - Verifique o formato do JSON enviado
   - Confirme se todos os campos obrigat√≥rios est√£o presentes
   - Teste com o endpoint `/webhook/health`

4. **Erro na busca de produtos**
   - Verifique as credenciais da Store API
   - Confirme se o `CUSTOMER_STORE_ID` est√° correto
   - Veja se o token n√£o expirou (sistema renova automaticamente)

5. **QR Code n√£o carrega**
   - Verifique se o ChatPro est√° configurado corretamente
   - Tente acessar `/chatpro/qrcode/display` diretamente
   - Confirme se o Instance ID e Token est√£o v√°lidos

## üéØ Pr√≥ximas Funcionalidades

- [ ] Suporte a envio de m√≠dia (imagens, documentos)
- [ ] Webhooks de status de entrega das mensagens
- [ ] Dashboard web para monitoramento
- [ ] Integra√ß√£o com mais provedores de WhatsApp
- [ ] Sistema de filas para mensagens em massa
- [ ] Relat√≥rios de mensagens enviadas

## üìÅ Estrutura do Projeto

```
whats-notify/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ index.js                    # Ponto de entrada da aplica√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ app/
‚îÇ       ‚îú‚îÄ‚îÄ setup.js                # Configura√ß√£o e inicializa√ß√£o dos servi√ßos
‚îÇ       ‚îú‚îÄ‚îÄ webhook.controller.js   # Controller para webhooks
‚îÇ       ‚îú‚îÄ‚îÄ webhook.router.js       # Rotas de webhook
‚îÇ       ‚îú‚îÄ‚îÄ chatpro.router.js       # Rotas espec√≠ficas do ChatPro
‚îÇ       ‚îú‚îÄ‚îÄ clients/                # Clientes para APIs externas
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ evolution.client.js # Cliente Evolution API
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ chatpro.client.js   # Cliente ChatPro API
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ storeapi.client.js  # Cliente Store API
‚îÇ       ‚îú‚îÄ‚îÄ config/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ index.js            # Configura√ß√µes da aplica√ß√£o
‚îÇ       ‚îú‚îÄ‚îÄ providers/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ whatsapp.provider.js # Abstra√ß√£o dos provedores WhatsApp
‚îÇ       ‚îî‚îÄ‚îÄ services/               # L√≥gica de neg√≥cio
‚îÇ           ‚îú‚îÄ‚îÄ notification.service.js # Servi√ßo de notifica√ß√µes
‚îÇ           ‚îú‚îÄ‚îÄ order.service.js    # Processamento de pedidos
‚îÇ           ‚îî‚îÄ‚îÄ product.service.js  # Busca de produtos
‚îú‚îÄ‚îÄ examples/
‚îÇ   ‚îî‚îÄ‚îÄ test-requests.js            # Exemplos de uso da API
‚îú‚îÄ‚îÄ .env.example                    # Exemplo de vari√°veis de ambiente
‚îú‚îÄ‚îÄ package.json                    # Depend√™ncias e scripts
‚îú‚îÄ‚îÄ vercel.json                     # Configura√ß√£o para deploy na Vercel
‚îú‚îÄ‚îÄ biome.json                      # Configura√ß√£o do linter/formatter
‚îî‚îÄ‚îÄ README.md                       # Documenta√ß√£o
```

## ü§ù Contribui√ß√£o

1. Fa√ßa um fork do projeto
2. Crie uma branch para sua feature (`git checkout -b feature/nova-feature`)
3. Commit suas mudan√ßas (`git commit -am 'Adiciona nova feature'`)
4. Push para a branch (`git push origin feature/nova-feature`)
5. Abra um Pull Request

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa ISC. Veja o arquivo `package.json` para mais detalhes.
